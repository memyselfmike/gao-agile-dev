# Story 7.3: Implement Atomic Git Commits

**Epic**: Epic 7 - Autonomous Artifact Creation & Git Integration
**Status**: Ready
**Priority**: P0 (Critical)
**Estimated Effort**: 3 story points
**Owner**: Amelia (Developer)
**Created**: 2025-10-28

---

## User Story

**As a** benchmark system
**I want** to automatically commit artifacts after each phase with descriptive messages
**So that** development progress is tracked and auditable in git history

---

## Context

After Stories 7.1 and 7.2:
- GAODevOrchestrator executes commands
- ArtifactParser extracts files and writes them to disk
- **Missing**: Automatic git commits after each artifact creation

This story implements the atomic commit workflow that mirrors real development practices.

---

## Acceptance Criteria

### AC1: Commit After Each Command
- [ ] Automatic commit after `create-prd` completes
- [ ] Automatic commit after `create-architecture` completes
- [ ] Automatic commit after `create-story` completes
- [ ] Automatic commit after each `implement-story` iteration
- [ ] Only commits if artifacts were created

### AC2: Conventional Commit Messages
- [ ] Format: `feat(phase-name): Create [artifact description]`
- [ ] Examples:
  - `feat(prd): Create Product Requirements Document`
  - `feat(architecture): Create system architecture design`
  - `feat(stories): Create user stories for Epic 1`
  - `feat(story-1.1): Implement authentication system`
- [ ] Includes benchmark run ID in commit body

### AC3: Selective Staging
- [ ] Only stages files created in current phase
- [ ] Does not commit unrelated changes
- [ ] Ignores node_modules, .venv, etc. (via .gitignore)
- [ ] Handles new files and modifications

### AC4: Commit Metadata
- [ ] Author: "GAO-Dev Benchmark <benchmark@gao-dev>"
- [ ] Timestamp recorded
- [ ] Commit SHA captured
- [ ] Benchmark run ID tagged

### AC5: Error Handling
- [ ] Handles merge conflicts gracefully
- [ ] Handles "nothing to commit" scenario
- [ ] Clear error messages
- [ ] Logs all git operations
- [ ] Continues benchmark on git errors (non-fatal)

---

## Technical Details

### Commit Workflow

```
Phase Execution
    -> Artifacts Created by Parser
    -> Files Written to Disk
    -> Git Add (staged files only)
    -> Git Commit (conventional message)
    -> Commit SHA Recorded
    -> Metrics Updated
```

### Implementation

```python
class GitCommitManager:
    """Handles atomic commits for benchmark artifacts."""

    def __init__(self, project_root: Path, run_id: str):
        self.project_root = project_root
        self.run_id = run_id
        self.git_manager = GitManager(project_root)

    def commit_artifacts(
        self,
        phase: str,
        artifact_paths: List[Path],
        description: str
    ) -> Optional[str]:
        """Create atomic commit for artifacts."""

        # Stage only the artifacts from this phase
        for path in artifact_paths:
            self.git_manager.stage_file(path)

        # Check if there's anything to commit
        if not self.git_manager.has_changes():
            logger.info(f"No changes to commit for phase: {phase}")
            return None

        # Create commit message
        commit_msg = self._format_commit_message(phase, description)

        # Commit
        commit_sha = self.git_manager.commit(
            message=commit_msg,
            author="GAO-Dev Benchmark <benchmark@gao-dev>"
        )

        logger.info(f"Created commit {commit_sha} for phase {phase}")
        return commit_sha

    def _format_commit_message(self, phase: str, description: str) -> str:
        """Format conventional commit message."""
        scope = self._phase_to_scope(phase)

        message = f"feat({scope}): {description}\n\n"
        message += f"Benchmark Run: {self.run_id}\n"
        message += f"Phase: {phase}\n"
        message += "\n"
        message += "Generated by GAO-Dev Benchmark\n"

        return message

    def _phase_to_scope(self, phase: str) -> str:
        """Map phase name to commit scope."""
        mapping = {
            "create-prd": "prd",
            "create-architecture": "architecture",
            "create-story": "stories",
            "implement-story": "implementation",
        }
        return mapping.get(phase, phase)
```

### Commit Message Examples

```
feat(prd): Create Product Requirements Document

Benchmark Run: run-20251028-143022
Phase: create-prd

Generated by GAO-Dev Benchmark
```

```
feat(story-1.1): Implement authentication system

Benchmark Run: run-20251028-143022
Phase: implement-story
Epic: 1
Story: 1.1

Generated by GAO-Dev Benchmark
```

---

## Files to Create

**New**:
- `gao_dev/sandbox/git_commit_manager.py` - Commit manager class
- `tests/sandbox/test_git_commit_manager.py` - Tests

**Modify**:
- `gao_dev/orchestrator/orchestrator.py` - Call commit manager after artifacts
- `gao_dev/sandbox/benchmark/orchestrator.py` - Integrate commits
- `gao_dev/core/git_manager.py` - Add helper methods if needed

---

## Dependencies

**Requires**:
- Story 7.1 (GAODevOrchestrator) - must be complete
- Story 7.2 (ArtifactParser) - must be complete
- Existing GitManager class

**Blocks**:
- Story 7.4 (Metrics Collection) - needs commit SHAs
- Story 7.5 (Artifact Verification) - checks git history

---

## Implementation Steps

1. **Create GitCommitManager Class**
   - Initialize with project_root and run_id
   - Methods for staging and committing
   - Commit message formatting

2. **Integrate with Orchestrator**
   - Call commit manager after artifacts created
   - Pass artifact paths
   - Capture commit SHA

3. **Add Metrics Tracking**
   - Record commit SHA in metrics
   - Track commit timestamp
   - Count commits per phase

4. **Error Handling**
   - Handle "nothing to commit"
   - Handle git errors
   - Log all operations

5. **Write Tests**
   - Unit tests for commit manager
   - Integration tests with git
   - Test error scenarios

---

## Testing Approach

### Unit Tests

```python
def test_commit_artifacts(tmp_path):
    """Test committing artifacts."""
    manager = GitCommitManager(tmp_path, "run-001")

    # Create artifacts
    (tmp_path / "docs").mkdir()
    (tmp_path / "docs" / "PRD.md").write_text("# PRD")

    # Commit
    sha = manager.commit_artifacts(
        phase="create-prd",
        artifact_paths=[Path("docs/PRD.md")],
        description="Create Product Requirements Document"
    )

    assert sha is not None
    assert len(sha) == 40  # Git SHA length

def test_conventional_commit_format():
    """Test commit message formatting."""
    manager = GitCommitManager(Path("/tmp"), "run-001")

    msg = manager._format_commit_message(
        "create-prd",
        "Create Product Requirements Document"
    )

    assert msg.startswith("feat(prd):")
    assert "Benchmark Run: run-001" in msg
    assert "Generated by GAO-Dev Benchmark" in msg

def test_no_changes_to_commit(tmp_path):
    """Test handling no changes."""
    manager = GitCommitManager(tmp_path, "run-001")

    sha = manager.commit_artifacts(
        phase="create-prd",
        artifact_paths=[],
        description="Create PRD"
    )

    assert sha is None  # No commit created
```

### Integration Tests
- Full benchmark run with commits
- Verify git log
- Check commit messages
- Validate commit metadata

---

## Edge Cases

1. **Nothing to Commit**: Return None, log info, continue
2. **Git Not Initialized**: Error, fail fast
3. **Merge Conflicts**: Shouldn't happen in isolated sandbox
4. **Large Files**: Git handles, but warn if >10MB
5. **Binary Files**: .gitignore prevents, but handle gracefully

---

## Definition of Done

- [ ] GitCommitManager implemented
- [ ] Commits created after each phase
- [ ] Conventional commit format followed
- [ ] Only relevant files staged
- [ ] Commit SHAs captured
- [ ] All tests passing (>90% coverage)
- [ ] Integration with orchestrator complete
- [ ] Code reviewed
- [ ] Documentation updated
- [ ] Committed with atomic commit

---

## Notes

**Why This Matters**: Atomic commits provide:
1. **Auditability**: See exactly what was created in each phase
2. **Recoverability**: Can roll back to any point
3. **Transparency**: Clear history of autonomous development
4. **Debugging**: Understand where issues were introduced

**Best Practice**: Each commit should represent a logical unit of work (one phase or one story).

---

**Created by**: Bob (Scrum Master) via BMAD workflow
**Ready for Implementation**: After Stories 7.1 and 7.2 complete
**Estimated Completion**: 2-3 hours

---

*This story makes GAO-Dev's autonomous development process transparent and auditable.*
