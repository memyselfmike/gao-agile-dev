name: Cross-Platform Onboarding Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'gao_dev/core/environment_detector.py'
      - 'gao_dev/cli/**'
      - 'tests/onboarding/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'gao_dev/core/environment_detector.py'
      - 'gao_dev/cli/**'
      - 'tests/onboarding/**'
  workflow_dispatch:

jobs:
  # Docker container environment tests
  test-docker:
    name: Docker Environment Tests
    runs-on: ubuntu-latest
    container:
      image: python:3.11-slim
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y git

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Docker environment tests
        run: |
          pytest tests/onboarding/test_docker_environment.py -v --tb=short
        env:
          GAO_DEV_DOCKER: "1"

      - name: Run environment detection tests
        run: |
          pytest tests/onboarding/test_environment_detection.py -v --tb=short -k "docker or container"
        env:
          GAO_DEV_DOCKER: "1"

  # SSH session simulation tests
  test-ssh:
    name: SSH Environment Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-onboarding-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-onboarding-

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run SSH environment tests
        run: |
          pytest tests/onboarding/test_ssh_environment.py -v --tb=short
        env:
          SSH_CLIENT: "192.168.1.1 54321 22"
          SSH_TTY: "/dev/pts/0"

  # WSL environment tests (Windows runner with WSL)
  test-wsl:
    name: WSL Environment Tests
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run WSL environment tests (simulated)
        run: |
          pytest tests/onboarding/test_wsl_environment.py -v --tb=short -m "not requires_wsl"

  # Desktop environment tests - Windows
  test-desktop-windows:
    name: Desktop Tests (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-onboarding-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-onboarding-

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Windows desktop tests
        run: |
          pytest tests/onboarding/test_desktop_environment.py -v --tb=short

      - name: Run wizard selection tests
        run: |
          pytest tests/onboarding/test_wizard_selection.py -v --tb=short

      - name: Run credential backend tests
        run: |
          pytest tests/onboarding/test_credential_backends.py -v --tb=short

  # Desktop environment tests - macOS
  test-desktop-macos:
    name: Desktop Tests (macOS)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-onboarding-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-onboarding-

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run macOS desktop tests
        run: |
          pytest tests/onboarding/test_desktop_environment.py -v --tb=short

  # Desktop environment tests - Linux with display
  test-desktop-linux:
    name: Desktop Tests (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-onboarding-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-onboarding-

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Linux desktop tests
        run: |
          pytest tests/onboarding/test_desktop_environment.py -v --tb=short
        env:
          DISPLAY: ":0"

  # Full onboarding flow and performance tests
  test-full-flow:
    name: Full Flow & Performance Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-benchmark

      - name: Run full onboarding flow tests
        run: |
          pytest tests/onboarding/test_full_onboarding_flow.py -v --tb=short

      - name: Run performance tests
        run: |
          pytest tests/onboarding/test_performance.py -v --tb=short --benchmark-only --benchmark-json=benchmark.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark.json

  # Coverage report aggregation
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-docker, test-ssh, test-desktop-linux, test-full-flow]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GAO-Dev
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate coverage report
        run: |
          pytest tests/onboarding/ -v --cov=gao_dev.core.environment_detector --cov-report=xml --cov-report=html --cov-report=term

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/

      - name: Check coverage threshold
        run: |
          pytest tests/onboarding/ --cov=gao_dev.core.environment_detector --cov-fail-under=80
