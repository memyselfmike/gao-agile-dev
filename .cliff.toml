# =============================================================================
# git-cliff Configuration for GAO-Dev Changelog Generation
# =============================================================================
# Automatically generates CHANGELOG.md from conventional commit messages.
#
# Usage:
#   git-cliff --config .cliff.toml --output CHANGELOG.md
#   git-cliff --config .cliff.toml --tag v0.2.0 --output CHANGELOG.md
#   git-cliff --config .cliff.toml --unreleased --output CHANGELOG.md
#
# Documentation: https://git-cliff.org/docs/configuration
# =============================================================================

[changelog]
# =============================================================================
# Changelog Header
# =============================================================================
# The header appears at the top of CHANGELOG.md and provides context about
# the changelog format and versioning scheme used.
# =============================================================================
header = """
# Changelog

All notable changes to GAO-Dev will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""

# =============================================================================
# Changelog Body Template
# =============================================================================
# This Jinja2 template defines how each version's changelog is formatted.
#
# Key features:
# - Groups commits by type (Features, Bug Fixes, etc.)
# - Highlights breaking changes with [**BREAKING**] tag
# - Shows commit scope (e.g., epic-36, brian, sandbox)
# - Sorts commits by scope within each group
# - Includes contributors section (if GitHub token provided)
# =============================================================================
body = """
{% if version -%}
## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
## [Unreleased]
{% endif -%}

{% for group, commits in commits | group_by(attribute="group") %}
### {{ group | striptags | trim | upper_first }}
{% for commit in commits
| filter(attribute="scope")
| sort(attribute="scope") %}
- **{{commit.scope}}**: {{ commit.message | upper_first }}\
    {% if commit.breaking %} [**BREAKING**]{% endif %}
{%- endfor %}
{% for commit in commits %}
{%- if not commit.scope -%}
- {{ commit.message | upper_first }}\
    {% if commit.breaking %} [**BREAKING**]{% endif %}
{% endif -%}
{% endfor -%}
{% endfor %}

{%- if github.contributors %}
### Contributors

{% for contributor in github.contributors | uniq(attribute="username") -%}
- @{{ contributor.username }} {%- if contributor.pr_title %} ({{ contributor.pr_title }}){% endif %}
{% endfor -%}
{% endif -%}

"""

# =============================================================================
# Changelog Footer
# =============================================================================
# Added to the end of the generated changelog.
# =============================================================================
footer = """
<!-- generated by git-cliff -->
"""

# =============================================================================
# Postprocessing
# =============================================================================
# Replace placeholders in the generated changelog.
# =============================================================================
trim = true
postprocessors = [
  { pattern = '<REPO>', replace = "https://github.com/memyselfmike/gao-agile-dev" },
]

# =============================================================================
# Git Commit Processing Configuration
# =============================================================================
# Defines how git commits are parsed, filtered, and grouped for changelog.
#
# Conventional Commits Format:
#   <type>(<scope>): <description>
#
#   [optional body]
#
#   [optional footer(s)]
#
# Breaking Changes:
#   - Include "BREAKING CHANGE:" in commit body or footer
#   - Or use "!" after type/scope: feat!: breaking change
# =============================================================================
[git]
# Enable conventional commit parsing
conventional_commits = true

# Include all commits (even non-conventional) for completeness
filter_unconventional = false

# Don't split commits by newlines
split_commits = false

# =============================================================================
# Commit Type Parsers
# =============================================================================
# Maps commit types to changelog sections. Order matters!
#
# Commit Types (from Conventional Commits spec):
#   - feat:     New feature
#   - fix:      Bug fix
#   - docs:     Documentation changes
#   - style:    Code style changes (formatting, missing semi-colons, etc.)
#   - refactor: Code refactoring (no feature changes or bug fixes)
#   - perf:     Performance improvements
#   - test:     Adding or updating tests
#   - chore:    Build process, dependency updates, etc.
#   - ci:       CI/CD configuration changes
#   - build:    Build system changes
#   - revert:   Revert previous commit
#
# Skip Flag: Commits marked with "skip = true" won't appear in changelog
# =============================================================================
commit_parsers = [
  # === User-Facing Changes (Included in Changelog) ===
  { message = "^feat", group = "Features" },
  { message = "^fix", group = "Bug Fixes" },
  { message = "^doc", group = "Documentation" },
  { message = "^perf", group = "Performance" },
  { message = "^refactor", group = "Refactoring" },

  # === Internal Changes (Excluded from Changelog) ===
  { message = "^style", group = "Styling", skip = true },
  { message = "^test", group = "Testing", skip = true },
  { message = "^chore\\(release\\):", skip = true },
  { message = "^chore\\(deps.*\\):", skip = true },
  { message = "^chore\\(pr\\):", skip = true },
  { message = "^chore\\(pull\\):", skip = true },
  { message = "^chore", group = "Miscellaneous Tasks", skip = true },
  { message = "^ci", group = "CI/CD", skip = true },
  { message = "^build", group = "Build", skip = true },

  # === Special Commit Types ===
  { body = ".*security", group = "Security" },
  { message = "^revert", group = "Reverts" },
  { message = "^wip", group = "Work in Progress", skip = true },
]

# =============================================================================
# Breaking Change Detection
# =============================================================================
# Protects commits with breaking changes from being skipped.
# Detects breaking changes via:
#   1. "BREAKING CHANGE:" in commit footer
#   2. "!" after type: feat!: breaking change
# =============================================================================
protect_breaking_commits = true

# Don't filter commits (include all)
filter_commits = false

# =============================================================================
# Tag Pattern
# =============================================================================
# Only process tags matching this pattern for version extraction.
# Supports semantic versioning: v0.1.0, v1.0.0, v0.1.0-beta.1
# =============================================================================
tag_pattern = "v[0-9].*"

# Use chronological order (not topological)
topo_order = false

# Sort commits oldest to newest
sort_commits = "oldest"

# =============================================================================
# GitHub Integration (Optional)
# =============================================================================
# Enables fetching GitHub metadata (contributors, PR links, etc.)
#
# To enable:
#   1. Generate GitHub Personal Access Token (PAT)
#   2. Set GITHUB_TOKEN environment variable OR
#   3. Add token to this config (not recommended - security risk)
#
# Without token: Contributors section won't appear in changelog
# =============================================================================
[remote.github]
owner = "memyselfmike"
repo = "gao-agile-dev"

# GitHub token for API access (optional)
# Better: export GITHUB_TOKEN=your_token_here
token = ""
